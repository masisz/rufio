# rufio

Ruby製のターミナルベースファイルマネージャー

**日本語** | [English](./README_EN.md)

## 概要

rufioは、Yaziにインスパイアされたターミナル上で動作するファイルマネージャーです。Rubyで実装されており、DSLコマンドによる拡張機能を備えています。軽量で高速な操作性を提供し、ファイルの閲覧・管理・検索機能を備えています。

### 🚀 v0.33.0の重要な更新

- **🚨 重大なパフォーマンス改善**: ファイルプレビューが40-86倍高速化（80ms → 1-2ms）
- **⚡ Zig実装追加**: 最小バイナリサイズ（52.6 KB）のネイティブスキャナー
- **📊 YJIT対応**: Ruby 3.4+ のJITコンパイラで全体的な性能向上

詳細は [CHANGELOG v0.33.0](./docs/CHANGELOG_v0.33.0.md) を参照してください。

## 特徴

- **軽量でシンプル**: Rubyで書かれた軽量なファイルマネージャー
- **直感的な操作**: Vimライクなキーバインド
- **DSLコマンドシステム** (v0.50.0): 拡張可能なDSLベースのコマンド定義
- **強力なコマンドモード** (v0.32.0):
  - シェルコマンド実行 (`!ls`, `!git status` など)
  - コマンド履歴（上下矢印キーでナビゲーション）
  - インテリジェントなTab補完（候補リスト表示）
  - DSLコマンドによる拡張可能なコマンド
- **バックグラウンドコマンド実行** (v0.33.0):
  - `:!command` でシェルコマンドを非同期実行
  - 実行中もrufioの操作が可能
  - 完了時に通知メッセージを表示
  - 実行結果を自動的にログファイルに保存
- **実行ログビューワ** (v0.33.0):
  - `L`キーでコマンド実行ログを閲覧
  - ログファイルのタイムスタンプ付き管理
  - ヘルプモードと同様の直感的なUI
- **高速ファイルプレビュー** (v0.33.0最適化):
  - 大幅な性能改善（40-86倍高速化）
  - 大規模ファイルも瞬時に表示（< 2ms）
  - スムーズなスクロールと快適な操作性
- **ファイル選択・操作**: 複数ファイルの選択、移動、コピー、削除が可能
- **リアルタイムフィルター**: sキーでファイル名の絞り込み表示
- **高度な検索機能**: fzfとrgaを使った強力な検索
- **マルチプラットフォーム**: macOS、Linux、Windowsで動作
- **外部エディタ連携**: お気に入りのエディタでファイルを開く
- **ヘルスチェック**: システム依存関係の確認機能
- **ステータスバー**: 処理時間、現在時刻、バージョン情報をリアルタイム表示
- **ブックマーク一覧表示**: フッタに1-9のブックマークを番号付きで表示
- **統合ヘルプシステム**: ？キーでキーバインド一覧とお知らせを表示

## インストール

```bash
gem install rufio
```

または、Gemfileに追加してください:

```ruby
gem 'rufio'
```

## 使い方

### 基本的な起動方法

```bash
rufio           # カレントディレクトリで起動
rufio /path/to  # 指定したディレクトリで起動
```

### ネイティブスキャナー（実験的機能）

rufio v0.31.0以降では、高速なディレクトリスキャンのためのネイティブ実装（Rust/Go/Zig）をサポートしています。デフォルトは安定したRuby実装を使用し、オプションでネイティブ実装に切り替え可能です。

#### 起動オプション

```bash
# デフォルト（Ruby実装 - 安定）
rufio

# ネイティブ実装を有効化（自動検出: Magnus > Zig > Rust > Go > Ruby）
rufio --native
rufio --native=auto

# Zig実装を使用（v0.33.0 - 実験的）
rufio --native=zig

# Rust実装を強制使用
rufio --native=rust
rufio --native rust /path/to/dir

# Go実装を強制使用
rufio --native=go
rufio --native go /path/to/dir

# 環境変数でも制御可能
RUFIO_NATIVE=zig rufio
RUFIO_NATIVE=rust rufio
RUFIO_NATIVE=go rufio /path/to/dir
```

#### ネイティブ実装について

- **Zig実装** (v0.33.0 - 実験的): 最小バイナリサイズ（52.6 KB）、高速、FFI不要
- **Magnus (Rust)**: 最速、メモリ安全、FFI不要（バイナリ: 314 KB）
- **Rust (FFI)**: 高速、メモリ安全、JSON経由
- **Go (FFI)**: 高速、並行処理に優れる
- **Ruby実装** (デフォルト): 依存なし、安定動作保証

**性能比較（163エントリ）:**
- Go (FFI): 0.242 ms（最速）
- Pure Ruby + YJIT: 0.242 ms（同等）
- Rust (FFI): 0.244 ms
- Zig: 0.253 ms（最小バイナリ）

#### ビルド方法

ネイティブ実装を使用するには、事前にビルドが必要です：

```bash
# Zig実装のビルド（v0.33.0 - 実験的）
cd lib_zig/rufio_native
make

# Rust実装のビルド
cd lib_rust/scanner
cargo build --release
make install

# Go実装のビルド
cd lib_go/scanner
make install
```

**必要な開発ツール:**
- Zig: Zig 0.15.2以降（`brew install zig` または https://ziglang.org/）
- Rust: Cargo（`curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh`）
- Go: Go 1.16以降（`brew install go` または https://golang.org/）

#### 注意事項

- ネイティブ実装は実験的機能です
- デフォルトではRuby実装を使用（`--native`オプションなし）
- ネイティブライブラリがない場合、自動的にRuby実装にフォールバック
- gemインストール時はネイティブライブラリが含まれます（ビルド不要）

### ヘルスチェック

```bash
rufio -c                # システム依存関係をチェック
rufio --check-health    # 上記と同じ
rufio --help           # ヘルプメッセージを表示
```

### キーバインド一覧

#### 基本ナビゲーション

| キー          | 機能                               |
| ------------- | ---------------------------------- |
| `j`           | 下に移動                           |
| `k`           | 上に移動                           |
| `h`           | 親ディレクトリに移動               |
| `l` / `Enter` | ディレクトリに入る・ファイルを選択 |

#### 高速ナビゲーション

| キー | 機能               |
| ---- | ------------------ |
| `g`  | リストの先頭に移動 |
| `G`  | リストの末尾に移動 |

#### ファイル操作

| キー | 機能                                               |
| ---- | -------------------------------------------------- |
| `o`  | 選択中のファイルを外部エディタで開く               |
| `e`  | 現在のディレクトリをファイルエクスプローラーで開く |
| `R`  | ディレクトリ内容を更新                             |
| `r`  | ファイル・ディレクトリ名をリネーム                 |
| `d`  | ファイル・ディレクトリを削除（確認ダイアログ付き） |
| `a`  | 新しいファイルを作成（ダイアログ入力）             |
| `A`  | 新しいディレクトリを作成（ダイアログ入力）         |

#### ファイル選択・操作

| キー    | 機能                                                 |
| ------- | ---------------------------------------------------- |
| `Space` | ファイル・ディレクトリを選択・選択解除（複数選択可） |
| `m`     | 選択したアイテムをカレントディレクトリに移動         |
| `c`     | 選択したアイテムをカレントディレクトリにコピー       |
| `x`     | 選択したアイテムを削除                               |

#### リアルタイムフィルター機能

| キー        | 機能                                       |
| ----------- | ------------------------------------------ |
| `f`         | フィルターモード開始・再編集               |
| 文字入力    | ファイル名で絞り込み（フィルターモード中） |
| `Enter`     | フィルター維持で通常モードに戻る           |
| `ESC`       | フィルターをクリアして通常モードに戻る     |
| `Backspace` | 文字削除（フィルターモード中）             |

#### 検索機能

| キー | 機能                                      |
| ---- | ----------------------------------------- |
| `s`  | fzfによるファイル名検索（プレビュー付き） |
| `F`  | rgaによるファイル内容検索                 |

#### ブックマーク機能

| キー      | 機能                                 |
| --------- | ------------------------------------ |
| `b`       | 現在のディレクトリをブックマークに追加 |
| `P`       | プロジェクトモードに入る (v0.33.0で変更) |
| `0`       | 起動したディレクトリに移動           |
| `1`-`9`   | 対応する番号のブックマークに移動     |

#### zoxide連携機能

| キー | 機能                               |
| ---- | ---------------------------------- |
| `z`  | zoxide履歴からディレクトリを選択移動 |

#### コマンドモード (v0.32.0 強化版)

| キー   | 機能                                     |
| ------ | ---------------------------------------- |
| `:`    | コマンドモードを起動                     |
| `Tab`  | コマンド補完・候補リスト表示（コマンドモード中）|
| `↑`    | 前のコマンドを表示（コマンドモード中）   |
| `↓`    | 次のコマンドを表示（コマンドモード中）   |
| `Enter`| コマンドを実行（コマンドモード中）       |
| `ESC`  | コマンドモードをキャンセル（コマンドモード中） |

**シェルコマンド実行** (v0.32.0):
```
:!ls -la          # ファイル一覧を表示
:!git status      # Gitステータスを確認
:!pwd             # 現在のディレクトリを表示
```

**バックグラウンド実行** (v0.33.0):
- `:!command` でシェルコマンドを非同期実行
- 実行中もrufioの操作が可能
- 完了時に通知メッセージを3秒間表示
- 実行結果は自動的に `~/.config/rufio/log/` に保存

**DSLコマンド** (v0.50.0):
```
:hello            # Hello DSLコマンドを実行
:stop             # rufioを終了
```

#### ログビューワ (v0.33.0)

| キー | 機能                               |
| ---- | ---------------------------------- |
| `L`  | コマンド実行ログを閲覧             |
| `ESC`| ログビューワモードを終了           |

コマンド実行ログは `~/.config/rufio/log/` に保存され、`L`キーで閲覧できます。

#### ヘルプ

| キー | 機能                               |
| ---- | ---------------------------------- |
| `?`  | キーバインド一覧とお知らせを表示 |

#### システム操作

| キー | 機能         |
| ---- | ------------ |
| `q`  | rufioを終了 |

### ファイル選択・操作機能の詳細

#### ファイル・ディレクトリ選択 (`Space`)

- **選択・選択解除**: `Space`キーでファイルやディレクトリを選択・選択解除
- **複数選択**: 複数のファイルやディレクトリを同時に選択可能
- **視覚的表示**: 選択されたアイテムは✓マークと緑色の背景で表示

#### ファイル操作

| 操作       | キー | 機能                                     |
| ---------- | ---- | ---------------------------------------- |
| **移動**   | `m`  | 選択したアイテムをカレントディレクトリに移動 |
| **コピー** | `c`  | 選択したアイテムをカレントディレクトリにコピー |
| **削除**   | `x`  | 選択したアイテムを削除                   |

#### 削除操作の詳細

- **フローティングダイアログ確認**: モダンなフローティングウィンドウで明確な選択肢を表示
- **視覚的フィードバック**: 赤い枠線と警告色で注意を引く
- **安全な操作**: 削除前のダブルチェック
- **包括的エラーハンドリング**: 削除失敗時の詳細なエラーメッセージ
- **リアルタイム結果表示**: フローティングダイアログで成功/失敗数を表示
- **ファイルシステム検証**: 成功報告前に実際の削除を確認
- **デバッグサポート**: BENIYA_DEBUG=1でオプションのデバッグログ出力

#### 操作の流れ

```
1. Space → ファイル・ディレクトリを選択（複数選択可）
2. 操作キーを選択:
   - m → カレントディレクトリに移動
   - c → カレントディレクトリにコピー
   - x → 削除
3. フローティングダイアログ → Y/Nで確認、ESCでキャンセル
4. 操作完了 → 選択解除、画面更新
```

#### 安全機能

- **フローティング確認ダイアログ**: 確認用のモダンなフローティングウィンドウインターフェース
- **視覚警告システム**: 危険な操作時の赤い枠線と警告色
- **重複チェック**: 同名ファイルがある場合は自動でスキップ
- **エラーハンドリング**: 権限不足などのエラーに適切に対応
- **操作ログ**: フローティングダイアログで処理結果を詳細表示
- **削除後検証**: ファイルシステムから実際に削除されたことを確認

### フィルター機能の詳細

#### リアルタイムフィルター (`f`)

- **フィルター開始**: `f`キーを押してフィルターモードに入る
- **文字入力による絞り込み**: 日本語・英数字・記号に対応
- **リアルタイム更新**: 文字を入力するたびに表示が更新される
- **フィルター維持**: `Enter`キーでフィルターを保持したまま通常操作に戻る
- **フィルタークリア**: `ESC`キーでフィルターをクリアして通常表示に戻る
- **再編集**: フィルター適用中に`f`キーで再編集モード
- **文字削除**: `Backspace`で文字削除、全削除時は自動でフィルタークリア

#### 使用例

```
1. f → フィルターモード開始
2. ".rb" → Rubyファイルのみ表示
3. Enter → フィルター維持で通常操作
4. j/k → フィルター結果内をナビゲーション
5. f → フィルター再編集
6. ESC → フィルタークリア
```

### 検索機能の詳細

#### ファイル名検索 (`s`)

- `fzf`を使用したインタラクティブなファイル名検索
- リアルタイムプレビュー表示
- 選択したファイルは自動で外部エディタで開かれる

#### ファイル内容検索 (`F`)

- `rga`（ripgrep-all）を使用した高度なファイル内容検索
- PDF、Word文書、画像内テキストなども検索対象
- 検索結果をfzfで絞り込み、該当行にジャンプしてファイルを開く

### ブックマーク機能の詳細

#### ブックマーク操作

**通常モード:**
- **`b`キー**: 現在のディレクトリをブックマークに追加
  - ディレクトリ名がタイトルに表示される
  - ブックマーク名を入力して追加
  - 重複パスは自動検出
  - 緑色のダイアログで表示（作成操作）

**プロジェクトモード (`p`キー):**
- **`SPACE`キー**: ブックマークをプロジェクトとして選択
  - 選択されたブックマークは✓マークと緑背景で表示
- **`r`キー**: カーソル位置のブックマークをリネーム
  - 黄色のダイアログで入力
  - 前後のスペースは自動削除
- **`d`キー**: カーソル位置のブックマークを削除
  - 赤色の確認ダイアログ表示
- **`l`キー**: ログモードに入る
- **`:`キー**: コマンドモード起動
- **`ESC`キー**: プロジェクトモードを終了

#### 高速ナビゲーション (`1`-`9`)

- 数字キーでブックマークに直接ジャンプ
- 最大9個のブックマークをサポート
- ブックマーク情報は画面上部に表示

#### ブックマークの永続化

- ブックマーク情報は `~/.config/rufio/bookmarks.json` に自動保存
- rufio再起動後もブックマーク情報が保持される
- 名前の前後のスペースは自動削除されて保存される
- JSONファイルを直接編集することも可能

### プロジェクトモード機能の詳細

#### プロジェクトモード (`p`)

プロジェクトモードでは、ブックマークしたディレクトリをプロジェクトとして管理できます。

#### スクリプト実行機能

- **スクリプトディレクトリ**: `~/.config/rufio/scripts`
  - 初回起動時に自動作成
  - `config.rb`でカスタマイズ可能
  - サンプルスクリプト `hello.rb` が含まれる
- **スクリプト実行**: `:`キーでコマンドモード起動
  - `.rb`ファイルを一覧表示
  - 選択したスクリプトを実行
  - プロジェクトコンテキストで実行

#### UI表示

プロジェクトモードのUIは通常モードと統一されています：

- **選択マーク**: ✓（チェックマーク）で選択を表示
- **選択済みブックマーク**: 緑背景、黒文字で表示
- **カーソル位置**: 設定ファイルの選択色でハイライト
- **セパレータ**: 左右画面の間に`│`を表示
- **フッター**: 反転表示でキーバインドを表示

#### 操作色の統一

- **緑色ダイアログ**: 作成操作（ファイル、ディレクトリ、ブックマーク）
- **青色ダイアログ**: ディレクトリ作成
- **黄色ダイアログ**: リネーム操作
- **赤色ダイアログ**: 削除操作

### zoxide連携機能の詳細

#### zoxide履歴移動 (`z`)

- **スマート履歴**: zoxideが記録したディレクトリ移動履歴を表示
- **フリークエンシー順**: よく使用するディレクトリほど上位に表示
- **インタラクティブ選択**: フローティングウィンドウで履歴を選択
- **高速ナビゲーション**: 数字キーで直接ディレクトリを選択
- **パス省略表示**: ホームディレクトリを`~`で表示し見やすく

#### 使用例

```
1. z → zoxide履歴メニューを表示
2. 1-20 → 表示された番号でディレクトリを選択
3. ESC → キャンセルして元の画面に戻る
```

#### zoxideについて

[zoxide](https://github.com/ajeetdsouza/zoxide)は、ディレクトリ移動履歴を学習するスマートなcdコマンドです。

```bash
# zoxideのインストール
# macOS (Homebrew)
brew install zoxide

# Ubuntu/Debian
apt install zoxide

# その他のインストール方法は公式ドキュメントを参照
# https://github.com/ajeetdsouza/zoxide#installation
```

#### 動作要件

- zoxideがシステムにインストールされている必要があります
- zoxideが無効な場合は適切なメッセージが表示されます
- 履歴が空の場合も適切にハンドリングされます

### コマンドモードの詳細

#### コマンドモードの起動 (`:`)

- `:`キーを押してコマンドモードを起動
- 画面最下部にコマンド入力欄が表示される
- プラグインが提供するコマンドを実行できる

#### Tab補完機能

- **インテリジェントな補完**: コマンド名の一部を入力して`Tab`キーを押すと自動補完
- **複数候補の処理**: 複数のコマンドが一致する場合は共通プレフィックスまで補完
- **単一候補の自動完成**: 一つだけマッチする場合は完全に補完される
- **リアルタイム更新**: 入力内容に応じて候補が動的に変化

#### フローティングウィンドウでの結果表示

- **視覚的フィードバック**: コマンド実行結果をモダンなフローティングウィンドウで表示
- **色分けされた結果**:
  - **緑色のボーダー**: コマンドが正常に実行された場合
  - **赤色のボーダー**: エラーまたは警告が発生した場合
- **中央配置**: 画面中央に自動的に配置され視認性が高い
- **自動サイズ調整**: 結果の内容に応じてウィンドウサイズが自動調整
- **簡単に閉じる**: 任意のキーを押すとウィンドウを閉じて通常操作に戻る

#### 使用例

```
1. : → コマンドモードを起動
2. "he" → コマンド名の一部を入力
3. Tab → 補完（"hello", "help", "health"などが候補）
4. Enter → コマンドを実行
5. フローティングウィンドウで結果を確認
6. 任意のキーを押してウィンドウを閉じる
```

#### 利用可能なコマンド

コマンドはDSLで定義されます。DSLコマンドシステムの詳細については後述の「DSLコマンドシステム」セクションを参照してください。

### 必要な外部ツール

検索機能・履歴機能を使用するには、以下のツールが必要です:

```bash
# macOS (Homebrew)
brew install fzf rga zoxide

# Ubuntu/Debian
apt install fzf zoxide
# rgaは別途インストールが必要: https://github.com/phiresky/ripgrep-all

# その他のLinuxディストリビューション
# パッケージマネージャーまたは手動インストールが必要
```

#### 各ツールの用途

- **fzf**: ファイル名検索機能（`s`キー）
- **rga**: ファイル内容検索機能（`F`キー）  
- **zoxide**: ディレクトリ履歴移動機能（`z`キー）

## 設定

### 色設定（カスタマイズ）

rufioではファイルタイプや UI 要素の色をカスタマイズできます。HSLカラーモデルによる直感的な色指定をサポートしています。

#### サポートされる色形式

```ruby
# HSL（色相・彩度・明度）- 推奨形式
{hsl: [220, 80, 60]}  # 色相220度、彩度80%、明度60%

# RGB（赤・緑・青）
{rgb: [100, 150, 200]}

# HEX（16進数）
{hex: "#6496c8"}

# 従来のシンボル
:blue, :red, :green, :yellow, :cyan, :magenta, :white, :black

# ANSIカラーコード
"34" または 34
```

#### 設定例

```ruby
# ~/.config/rufio/config.rb
COLORS = {
  # HSLでの色指定（直感的で調整しやすい）
  directory: {hsl: [220, 80, 60]},    # 青系でディレクトリ
  file: {hsl: [0, 0, 90]},            # 薄いグレーで通常ファイル
  executable: {hsl: [120, 70, 50]},   # 緑系で実行ファイル
  selected: {hsl: [50, 90, 70]},      # 黄色で選択項目
  preview: {hsl: [180, 60, 65]},      # シアンでプレビュー

  # 他の形式も併用可能
  # directory: :blue,                 # シンボル
  # file: {rgb: [200, 200, 200]},     # RGB
  # executable: {hex: "#00aa00"},     # HEX
}
```

#### HSLカラーモデルについて

- **色相（Hue）**: 0-360度（0=赤、120=緑、240=青）
- **彩度（Saturation）**: 0-100%（0=グレー、100=鮮やか）
- **明度（Lightness）**: 0-100%（0=黒、50=標準、100=白）

#### 設定可能な項目

- `directory`: ディレクトリの色
- `file`: 通常ファイルの色
- `executable`: 実行可能ファイルの色
- `selected`: 選択中の項目の色
- `preview`: プレビューパネルの色

## DSLコマンドシステム

rufioはDSLベースのコマンドシステムを備えており、独自のコマンドを簡単に追加できます。

### コマンド定義ファイル

ユーザー定義コマンドは以下のファイルに記述します:

```
~/.config/rufio/commands.rb
```

### コマンドの作成方法

#### Rubyコードを実行するコマンド

```ruby
# ~/.config/rufio/commands.rb
command "hello" do
  ruby { "Hello from rufio!" }
  description "挨拶コマンド"
end

command "time" do
  ruby { Time.now.strftime("%Y-%m-%d %H:%M:%S") }
  description "現在時刻を表示"
end
```

#### シェルコマンドを実行するコマンド

```ruby
command "status" do
  shell "git status"
  description "Gitステータスを表示"
end

command "disk" do
  shell "df -h"
  description "ディスク使用量を表示"
end
```

#### 外部スクリプトを実行するコマンド

```ruby
command "build" do
  script "~/.config/rufio/scripts/build.rb"
  description "プロジェクトをビルド"
end
```

### コマンドの使い方

1. rufioを起動
2. `:`キーでコマンドモードを起動
3. コマンド名を入力（または一部を入力してTabキーで補完）
4. Enterキーで実行
5. フローティングウィンドウに結果が表示される

### 組み込みコマンド

rufioには以下のコマンドがデフォルトで組み込まれています:

| コマンド | 説明 |
| -------- | ---- |
| `hello`  | 挨拶メッセージを表示 |
| `stop`   | rufioを終了 |
| `touch`  | ファイルを作成 |
| `mkdir`  | ディレクトリを作成 |

### DSLコマンドの種類

1. **ruby**: Rubyコードをインラインで実行
2. **shell**: シェルコマンドを実行
3. **script**: 外部スクリプトファイルを実行

### 設定ファイル構成

```
~/.config/rufio/
├── config.rb         # カラー設定
├── commands.rb       # DSLコマンド定義
├── bookmarks.json    # ブックマーク
├── scripts/          # スクリプトファイル
└── log/              # 実行ログ
```

## 開発

### 必要な環境

- Ruby 2.7.0以上
- io-console, pastel, tty-cursor, tty-screen gems

### 開発版の実行

```bash
git clone https://github.com/masisz/rufio
cd rufio
bundle install
./exe/rufio
```

### テスト実行

```bash
bundle exec rake test
```

## 対応プラットフォーム

- **macOS**: ネイティブサポート
- **Linux**: ネイティブサポート
- **Windows**: 基本機能をサポート

## ライセンス

MIT License

## 貢献

バグ報告や機能リクエストは[GitHub Issues](https://github.com/masisz/rufio/issues)でお願いします。

プルリクエストも歓迎です！

### 開発ガイドライン

1. 既存のコードスタイルと規約に従う
2. 新機能にはテストを追加する
3. 必要に応じてドキュメントを更新する
4. 可能であれば複数のプラットフォームでテストする
