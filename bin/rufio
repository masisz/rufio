#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib/rufio'

# プラグインを読み込む
Rufio::PluginManager.load_all

# YJITを早期に有効化（引数をチェック）
if ARGV.include?('--yjit') && defined?(RubyVM::YJIT)
  RubyVM::YJIT.enable
end

# ZJITを早期に有効化（引数をチェック）
if ARGV.include?('--zjit') && defined?(RubyVM::ZJIT)
  RubyVM::ZJIT.enable
end

# コマンドライン引数のパース
native_mode = nil
start_directory = nil
test_mode = false
yjit_mode = false
zjit_mode = false
skip_next = false

ARGV.each_with_index do |arg, idx|
  if skip_next
    skip_next = false
    next
  end

  case arg
  when '--test'
    test_mode = true
  when '--yjit'
    yjit_mode = true
  when '--zjit'
    zjit_mode = true
  when '--native'
    # 次の引数がモード指定かチェック
    if idx + 1 < ARGV.length && !ARGV[idx + 1].start_with?('--') && !ARGV[idx + 1].start_with?('/')
      next_arg = ARGV[idx + 1]
      if %w[rust go auto ruby].include?(next_arg)
        native_mode = next_arg
        skip_next = true
      else
        native_mode = 'auto'
      end
    else
      native_mode = 'auto'
    end
  when /^--native=(rust|go|auto|ruby)$/
    native_mode = $1
  when '-c', '--check-health', '--help', '-h', '--yjit', '--zjit'
    # これらは後で処理
  when /^--/
    # 未知のオプションは無視
  else
    # 最初の非オプション引数をディレクトリとして扱う
    start_directory ||= arg
  end
end

# ネイティブスキャナーモードを設定（native_scannerが存在する場合のみ）
if native_mode && defined?(Rufio::NativeScanner)
  Rufio::NativeScanner.mode = native_mode
end

# 環境変数でも制御可能
if ENV['RUFIO_NATIVE'] && defined?(Rufio::NativeScanner)
  Rufio::NativeScanner.mode = ENV['RUFIO_NATIVE']
end

# コマンド処理
if ARGV.include?('--check-health') || ARGV.include?('-c')
  # ヘルスチェック実行
  health_checker = Rufio::HealthChecker.new
  success = health_checker.run_check
  exit(success ? 0 : 1)
elsif ARGV.include?('--help') || ARGV.include?('-h')
  puts "rufio - Terminal-based file manager"
  puts ""
  puts "Usage:"
  puts "  rufio [OPTIONS] [DIRECTORY]"
  puts ""
  puts "Options:"
  puts "  -c, --check-health        Check system dependencies"
  puts "  -h, --help                Show this help message"
  puts "  --test                    Show FPS counter in footer (for performance testing)"
  puts "  --yjit                    Enable YJIT JIT compiler (Ruby 3.1+)"
  puts "  --zjit                    Enable ZJIT JIT compiler (Ruby 3.4+)"
  if defined?(Rufio::NativeScanner)
    puts "  --native[=MODE]           Enable native scanner (experimental)"
    puts "                            MODE: auto|rust|go (default: auto)"
    puts ""
    puts "Native Scanner:"
    puts "  By default, rufio uses Ruby implementation for stability."
    puts "  Native scanners (Rust/Go) are experimental and can be enabled with --native."
    puts ""
    puts "  --native                  Auto-detect (Rust > Go > Ruby)"
    puts "  --native=rust             Use Rust implementation"
    puts "  --native=go               Use Go implementation"
    puts "  --native=auto             Same as --native"
    puts "  --native=ruby             Use Ruby implementation (default)"
    puts ""
    puts "  Environment variable: RUFIO_NATIVE=rust|go|auto"
  end
  puts ""
  puts "Examples:"
  puts "  rufio                     # Start in current directory"
  puts "  rufio /path/to/dir        # Start in specific directory"
  puts "  rufio --test              # Show FPS counter for performance testing"
  puts "  rufio --yjit              # Enable YJIT for better performance"
  puts "  rufio --zjit              # Enable ZJIT for better performance"
  if defined?(Rufio::NativeScanner)
    puts "  rufio --native            # Use native scanner (auto-detect)"
    puts "  rufio --native=rust       # Use Rust scanner"
    puts "  rufio --native rust /tmp  # Use Rust scanner in /tmp"
    puts "  RUFIO_NATIVE=rust rufio   # Use Rust via environment variable"
  end
  puts "  rufio -c                  # Check dependencies"
  exit(0)
else
  start_directory ||= Dir.pwd

  # アプリケーション開始
  app = Rufio::Application.new(start_directory)
  app.run(test_mode: test_mode)
end